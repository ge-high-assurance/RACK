# Builds rack-box virtual machine (reusable workflow)

name: RACK Build Virtual Machine Workflow
on:
  workflow_call:
    inputs:
      version:
        required: false
        default: 'dev'
        type: string

jobs:

# build-virtual-machine job:
#  - Builds rack-box virtual machine
#  - Uploads virtual machine to workflow or release

  build-virtual-machine:
    runs-on: macos-12

    steps:
    - name: Check out RACK source
      uses: actions/checkout@v3
      with:
        repository: ge-high-assurance/RACK
        path: RACK

    - name: Ask cache for rack-box files
      uses: actions/cache@v3
      id: cache
      with:
        path: RACK/rack-box/files
        key: files-${{ github.sha }}

    - name: We don't have rack-box files?
      if: steps.cache.outputs.cache-hit == false
      run: |
        echo "::error rack-box files are missing"
        exit 1

    - name: Download base box for virtual machine
      run: |
        curl -LOSfs https://app.vagrantup.com/ubuntu/boxes/focal64/versions/20221115.1.0/providers/virtualbox.box
        mkdir -p RACK/rack-box/focal64
        tar -xf virtualbox.box -C RACK/rack-box/focal64
        rm -f virtualbox.box

    - name: Build rack-box virtual machine
      run: |
        cd RACK/rack-box
        packer build -var headless=true -var version=${{ inputs.version }} rack-box-virtualbox.json

    - name: Upload rack-box virtual machine to workflow
      uses: actions/upload-artifact@v3
      if: github.event_name != 'release'
      with:
        name: rack-box-${{ inputs.version }}
        path: RACK/rack-box/output-virtualbox-ovf

    - name: Split rack-box virtual machine
      if: github.event_name == 'release'
      run: |
        cd RACK/rack-box
        mv output-output-virtualbox-ovf rack-box-${{ inputs.version }}
        zip -r rack-box-${{ inputs.version }}.zip rack-box-${{ inputs.version }}
        split -b 1500m rack-box-${{ inputs.version }}.zip

    - name: Upload split virtual machine (1/2) to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: RACK/rack-box/xaa
        asset_name: rack-box-${{ inputs.version }}.zipaa
        asset_content_type: application/octet-stream

    - name: Upload split virtual machine (2/2) to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: RACK/rack-box/xab
        asset_name: rack-box-${{ inputs.version }}.zipab
        asset_content_type: application/octet-stream

    - name: Upload readme to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: RACK/rack-box/GitHub-Release-README.md
        asset_name: README.md
        asset_content_type: text/markdown; charset=UTF-8
